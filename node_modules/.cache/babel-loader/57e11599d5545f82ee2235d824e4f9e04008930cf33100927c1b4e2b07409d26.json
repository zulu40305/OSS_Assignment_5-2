{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = resolveRewrites;\nvar _pathMatch = require(\"./path-match\");\nvar _prepareDestination = require(\"./prepare-destination\");\nvar _removeTrailingSlash = require(\"./remove-trailing-slash\");\nvar _normalizeLocalePath = require(\"../../i18n/normalize-locale-path\");\nvar _removeBasePath = require(\"../../../../client/remove-base-path\");\nvar _parseRelativeUrl = require(\"./parse-relative-url\");\nfunction resolveRewrites(asPath, pages, rewrites, query, resolveHref, locales) {\n  let matchedPage = false;\n  let externalDest = false;\n  let parsedAs = (0, _parseRelativeUrl).parseRelativeUrl(asPath);\n  let fsPathname = (0, _removeTrailingSlash).removeTrailingSlash((0, _normalizeLocalePath).normalizeLocalePath((0, _removeBasePath).removeBasePath(parsedAs.pathname), locales).pathname);\n  let resolvedHref;\n  const handleRewrite = rewrite => {\n    const matcher = (0, _pathMatch).getPathMatch(rewrite.source + (process.env.__NEXT_TRAILING_SLASH ? '(/)?' : ''), {\n      removeUnnamedParams: true,\n      strict: true\n    });\n    let params = matcher(parsedAs.pathname);\n    if ((rewrite.has || rewrite.missing) && params) {\n      const hasParams = (0, _prepareDestination).matchHas({\n        headers: {\n          host: document.location.hostname\n        },\n        cookies: document.cookie.split('; ').reduce((acc, item) => {\n          const [key, ...value] = item.split('=');\n          acc[key] = value.join('=');\n          return acc;\n        }, {})\n      }, parsedAs.query, rewrite.has, rewrite.missing);\n      if (hasParams) {\n        Object.assign(params, hasParams);\n      } else {\n        params = false;\n      }\n    }\n    if (params) {\n      if (!rewrite.destination) {\n        // this is a proxied rewrite which isn't handled on the client\n        externalDest = true;\n        return true;\n      }\n      const destRes = (0, _prepareDestination).prepareDestination({\n        appendParamsToQuery: true,\n        destination: rewrite.destination,\n        params: params,\n        query: query\n      });\n      parsedAs = destRes.parsedDestination;\n      asPath = destRes.newUrl;\n      Object.assign(query, destRes.parsedDestination.query);\n      fsPathname = (0, _removeTrailingSlash).removeTrailingSlash((0, _normalizeLocalePath).normalizeLocalePath((0, _removeBasePath).removeBasePath(asPath), locales).pathname);\n      if (pages.includes(fsPathname)) {\n        // check if we now match a page as this means we are done\n        // resolving the rewrites\n        matchedPage = true;\n        resolvedHref = fsPathname;\n        return true;\n      }\n      // check if we match a dynamic-route, if so we break the rewrites chain\n      resolvedHref = resolveHref(fsPathname);\n      if (resolvedHref !== asPath && pages.includes(resolvedHref)) {\n        matchedPage = true;\n        return true;\n      }\n    }\n  };\n  let finished = false;\n  for (let i = 0; i < rewrites.beforeFiles.length; i++) {\n    // we don't end after match in beforeFiles to allow\n    // continuing through all beforeFiles rewrites\n    handleRewrite(rewrites.beforeFiles[i]);\n  }\n  matchedPage = pages.includes(fsPathname);\n  if (!matchedPage) {\n    if (!finished) {\n      for (let i = 0; i < rewrites.afterFiles.length; i++) {\n        if (handleRewrite(rewrites.afterFiles[i])) {\n          finished = true;\n          break;\n        }\n      }\n    }\n    // check dynamic route before processing fallback rewrites\n    if (!finished) {\n      resolvedHref = resolveHref(fsPathname);\n      matchedPage = pages.includes(resolvedHref);\n      finished = matchedPage;\n    }\n    if (!finished) {\n      for (let i = 0; i < rewrites.fallback.length; i++) {\n        if (handleRewrite(rewrites.fallback[i])) {\n          finished = true;\n          break;\n        }\n      }\n    }\n  }\n  return {\n    asPath,\n    parsedAs,\n    matchedPage,\n    resolvedHref,\n    externalDest\n  };\n}","map":{"version":3,"names":["resolveRewrites","_pathMatch","require","_prepareDestination","_removeTrailingSlash","_normalizeLocalePath","_removeBasePath","_parseRelativeUrl","asPath","pages","rewrites","query","resolveHref","locales","matchedPage","externalDest","parsedAs","parseRelativeUrl","fsPathname","removeTrailingSlash","normalizeLocalePath","removeBasePath","pathname","resolvedHref","handleRewrite","rewrite","matcher","getPathMatch","source","process","env","__NEXT_TRAILING_SLASH","removeUnnamedParams","strict","params","has","missing","hasParams","matchHas","headers","host","document","location","hostname","cookies","cookie","split","reduce","acc","item","key","value","join","Object","assign","destination","destRes","prepareDestination","appendParamsToQuery","parsedDestination","newUrl","includes","finished","i","beforeFiles","length","afterFiles","fallback"],"sources":["../../../../../shared/lib/router/utils/resolve-rewrites.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}